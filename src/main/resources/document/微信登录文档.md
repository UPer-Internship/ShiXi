# 微信登录功能文档

## 接口

### 微信登录接口

**接口地址**: `POST /user/login/byWechat`

**请求参数**:

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| code | String | 是 | 微信小程序调用 wx.login() 获取的授权码 |
| phone | String | 否 | 手机号（新用户首次登录时必填） 老用户登录时无需提供|

**请求示例**:
```json
{
  "code": "081Fh0Ga1rE2PC0s3IGa1s2W4k2Fh0Gm",
  "phone": "13800138000"
}
```

**响应格式**:

成功响应:
```json
{
  "success": true,
  "data": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "errorMsg": null
}
```

失败响应:
```json
{
  "success": false,
  "data": null,
  "errorMsg": "新用户首次登录必须提供手机号"
}
```

## 业务逻辑说明

### 登录流程

1. **获取微信授权码**
   - 前端调用 `wx.login()` 获取 code
   - code 有效期为 5 分钟

2. **调用登录接口**
   - 将 code 发送到后端接口
   - 新用户需要同时提供手机号

3. **后端处理流程**
   - 通过 code 向微信服务器获取 openid
   - 根据 openid 查询用户是否存在
   - 用户不存在时的处理逻辑（见下文）
   - 生成登录 token 并缓存用户信息

4. **返回登录凭证**
   - 成功时返回 token
   - 前端需要保存 token 用于后续请求

### 用户创建/绑定逻辑

#### 场景一：老用户登录
- 系统中已存在该 openid 对应的用户
- 直接生成 token 完成登录

#### 场景二：新用户首次登录
- 系统中不存在该 openid 对应的用户
- **必须提供手机号**，否则返回错误

#### 场景三：手机号已存在的用户
- 新的 openid，但手机号已被注册
- 将新的 openid 绑定到已有账号
- 实现微信账号与手机号账号的关联
- 这个情况是用来给已经有手机号的旧用户绑定微信账号用的，使用时需要同时传手机号和openid

## 前端调试指南
具体流程可以参考微信小程序开发文档[微信登录流程](https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/login.html]